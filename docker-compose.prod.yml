# =============================================================================
# Docker Compose - PRODUCCIÓN
# Optimizado, seguro, sin herramientas de debug
# =============================================================================
#
# Uso:  docker compose -f docker-compose.prod.yml up -d
#
# Características:
# - Sin hot reload (imagen construida)
# - Sin pgAdmin (acceso directo a DB prohibido)
# - Logs en JSON para observability
# - Health checks estrictos
# - Recursos limitados

services:
  # ===========================================================================
  # PostgreSQL 16 con pgvector
  # ===========================================================================
  db:
    image: pgvector/pgvector:pg16
    container_name: finanzas_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - finanzas_prod_network
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    # NO exponer puerto externamente en producción
    # ports:
    #   - "5432:5432"

  # ===========================================================================
  # FastAPI Application
  # ===========================================================================
  api:
    image: ${IMAGE_NAME:-ghcr.io/sebascrugu/finanzas-email-tracker}:${IMAGE_TAG:-latest}
    container_name: finanzas_api
    restart: always
    ports:
      - "8000:8000"
    environment:
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - finanzas_prod_network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # ===========================================================================
  # Redis para cache (opcional)
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: finanzas_redis
    restart: always
    volumes:
      - redis_prod_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - finanzas_prod_network
    deploy:
      resources:
        limits:
          memory: 128M
    profiles:
      - cache

volumes:
  postgres_prod_data:
  redis_prod_data:

networks:
  finanzas_prod_network:
    driver: bridge
